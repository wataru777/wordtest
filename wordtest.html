<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語句・ことわざテスト</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .start-screen {
            text-align: center;
        }
        
        .mode-button {
            display: inline-block;
            margin: 10px;
            padding: 20px 40px;
            font-size: 1.2em;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-button:hover {
            background: #4c51bf;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .quiz-screen {
            display: none;
        }
        
        .question-number {
            text-align: center;
            color: #718096;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .question {
            background: #f7fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            font-size: 1.3em;
            color: #2d3748;
            line-height: 1.6;
            border: 2px solid #e2e8f0;
        }
        
        .question .underline {
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-underline-offset: 4px;
            text-decoration-color: #5a67d8;
            font-weight: bold;
        }
        
        .choices {
            display: grid;
            gap: 15px;
        }
        
        .choice-button {
            padding: 18px 25px;
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .choice-button:hover:not(.disabled) {
            background: #edf2f7;
            border-color: #5a67d8;
            transform: translateX(5px);
        }
        
        .choice-button.correct {
            background: #c6f6d5;
            border-color: #48bb78;
            animation: correctPulse 0.5s ease;
        }
        
        .choice-button.incorrect {
            background: #fed7d7;
            border-color: #f56565;
            animation: shake 0.5s ease;
        }
        
        .choice-button.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 100;
        }
        
        .feedback-circle {
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 200px;
            font-weight: normal;
            animation: feedbackPop 0.6s ease-out;
        }
        
        .feedback-circle.correct {
            color: #48bb78;
        }
        
        .feedback-circle.incorrect {
            color: #f56565;
        }
        
        @keyframes feedbackPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.9;
            }
        }
        
        .result-screen {
            display: none;
            text-align: center;
        }
        
        .score {
            font-size: 3em;
            color: #5a67d8;
            margin: 20px 0;
        }
        
        .grade {
            font-size: 4em;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .grade.s { color: #f6e05e; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .grade.a { color: #f56565; }
        .grade.b { color: #4299e1; }
        .grade.c { color: #48bb78; }
        
        .comment {
            font-size: 1.3em;
            color: #4a5568;
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .restart-button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 1.2em;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .restart-button:hover {
            background: #4c51bf;
            transform: translateY(-2px);
        }
        
        .add-question-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #ed8936;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .add-question-button:hover {
            background: #dd6b20;
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .question-list {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .question-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
        }
        
        .question-item:hover {
            background: #edf2f7;
        }
        
        .question-text {
            flex: 1;
            margin-right: 10px;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .edit-button, .delete-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .edit-button {
            background: #4299e1;
            color: white;
        }
        
        .edit-button:hover {
            background: #3182ce;
        }
        
        .delete-button {
            background: #f56565;
            color: white;
        }
        
        .delete-button:hover {
            background: #e53e3e;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #5a67d8;
            color: white;
            border-color: #5a67d8;
        }
        
        .choice-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .choice-type-button {
            padding: 8px 15px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .choice-type-button.active {
            background: #5a67d8;
            color: white;
            border-color: #5a67d8;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .form-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .save-button {
            background: #48bb78;
            color: white;
        }
        
        .save-button:hover {
            background: #38a169;
        }
        
        .cancel-button {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .cancel-button:hover {
            background: #cbd5e0;
        }
        
        .next-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            padding: 20px 40px;
            background: white;
            color: #4a5568;
            border: 2px solid #5a67d8;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            width: 100%;
            max-width: 300px;
        }
        
        .next-button:hover {
            background: #edf2f7;
            border-color: #4c51bf;
            transform: translate(-50%, -50%) translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .next-button.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="feedback-overlay" id="feedbackOverlay"></div>
    
    <div class="container">
        <div class="start-screen" id="startScreen">
            <h1>語句・ことわざテスト</h1>
            <p style="margin-bottom: 30px; color: #4a5568; font-size: 1.1em;">どちらのテストを受けますか？</p>
            <button class="mode-button" onclick="startQuiz('vocabulary')">語句テスト</button>
            <button class="mode-button" onclick="startQuiz('proverb')">ことわざテスト</button>
        </div>
        
        <div class="quiz-screen" id="quizScreen">
            <div class="question-number" id="questionNumber"></div>
            <div class="question" id="questionText"></div>
            <div class="choices" id="choices"></div>
            <div style="text-align: center; height: 80px; position: relative;">
                <button class="next-button" id="nextButton" onclick="nextQuestion()">次の問題へ</button>
            </div>
        </div>
        
        <div class="result-screen" id="resultScreen">
            <h1>テスト結果</h1>
            <div class="score" id="score"></div>
            <div class="grade" id="grade"></div>
            <div class="comment" id="comment"></div>
            <button class="restart-button" onclick="restartQuiz()">もう一度挑戦</button>
        </div>
    </div>
    
    <button class="add-question-button" onclick="showQuestionManager()">+</button>
    
    <div class="modal" id="questionManagerModal">
        <div class="modal-content">
            <h2>問題管理</h2>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('add')">問題を追加</button>
                <button class="tab-button" onclick="switchTab('manage')">問題を管理</button>
            </div>
            
            <div id="addQuestionTab">
                <form id="addQuestionForm">
                    <div class="form-group">
                        <label>問題の種類</label>
                        <select id="questionType">
                            <option value="vocabulary">語句</option>
                            <option value="proverb">ことわざ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>選択肢の数</label>
                        <div class="choice-type-selector">
                            <button type="button" class="choice-type-button" onclick="setChoiceCount(3)">3択</button>
                            <button type="button" class="choice-type-button active" onclick="setChoiceCount(4)">4択</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>問題文</label>
                        <textarea id="questionTextInput" required></textarea>
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            ヒント: アンダーバーを引きたい部分を [[ ]] で囲んでください<br>
                            例: 友人の失敗を見て、彼は[[あざ笑った]]
                        </small>
                    </div>
                    <div class="form-group">
                        <label>正解</label>
                        <input type="text" id="correctAnswer" required>
                    </div>
                    <div class="form-group">
                        <label>不正解の選択肢1</label>
                        <input type="text" id="wrongAnswer1" required>
                    </div>
                    <div class="form-group">
                        <label>不正解の選択肢2</label>
                        <input type="text" id="wrongAnswer2" required>
                    </div>
                    <div class="form-group" id="wrongAnswer3Group">
                        <label>不正解の選択肢3</label>
                        <input type="text" id="wrongAnswer3">
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="form-button cancel-button" onclick="hideQuestionManager()">キャンセル</button>
                        <button type="submit" class="form-button save-button">保存</button>
                    </div>
                </form>
            </div>
            
            <div id="manageQuestionsTab" style="display: none;">
                <div class="form-group">
                    <label>問題の種類</label>
                    <select id="manageQuestionType" onchange="loadQuestionsForManagement()">
                        <option value="vocabulary">語句</option>
                        <option value="proverb">ことわざ</option>
                    </select>
                </div>
                <div class="question-list" id="questionList"></div>
                <div class="form-buttons">
                    <button type="button" class="form-button cancel-button" onclick="hideQuestionManager()">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 問題データ（オリジナルを保存）
        const originalQuestions = {
            vocabulary: [
                {
                    question: "「[[憂鬱]]」の読み方は？",
                    choices: ["ゆううつ", "ゆうえつ", "うれいうつ", "ゆうぶつ"],
                    correct: 0
                },
                {
                    question: "「[[邪魔]]」の意味として正しいものは？",
                    choices: ["助けること", "妨げること", "守ること", "集めること"],
                    correct: 1
                },
                {
                    question: "「[[素朴]]」の読み方は？",
                    choices: ["そぼく", "すぼく", "そはく", "すはく"],
                    correct: 0
                },
                {
                    question: "「[[謙虚]]」の意味として正しいものは？",
                    choices: ["威張ること", "怒ること", "控えめなこと", "急ぐこと"],
                    correct: 2
                },
                {
                    question: "「[[繊細]]」の読み方は？",
                    choices: ["せんさい", "せんざい", "しんさい", "しんざい"],
                    correct: 0
                },
                {
                    question: "「[[寛容]]」の意味として正しいものは？",
                    choices: ["厳しいこと", "心が広いこと", "小さいこと", "速いこと"],
                    correct: 1
                },
                {
                    question: "「[[朗読]]」の読み方は？",
                    choices: ["ろうどく", "ろうとく", "らんどく", "らんとく"],
                    correct: 0
                },
                {
                    question: "「[[勤勉]]」の意味として正しいものは？",
                    choices: ["怠けること", "遊ぶこと", "よく働き学ぶこと", "寝ること"],
                    correct: 2
                },
                {
                    question: "「[[穏やか]]」の読み方は？",
                    choices: ["おだやか", "おんやか", "おとやか", "おなやか"],
                    correct: 0
                },
                {
                    question: "「[[誠実]]」の意味として正しいものは？",
                    choices: ["嘘をつくこと", "真面目で正直なこと", "速いこと", "大きいこと"],
                    correct: 1
                },
                {
                    question: "「[[紛糾]]」の読み方は？",
                    choices: ["ふんきゅう", "ふんけい", "ぶんきゅう", "ぶんけい"],
                    correct: 0
                },
                {
                    question: "「[[憤慨]]」の意味として正しいものは？",
                    choices: ["喜ぶこと", "ひどく怒ること", "悲しむこと", "驚くこと"],
                    correct: 1
                },
                {
                    question: "「[[錯覚]]」の読み方は？",
                    choices: ["さっかく", "さくかく", "しゃっかく", "しゃくかく"],
                    correct: 0
                },
                {
                    question: "「[[抽象的]]」の意味として正しいものは？",
                    choices: ["具体的なこと", "はっきりしないこと", "小さいこと", "新しいこと"],
                    correct: 1
                },
                {
                    question: "「[[殊勝]]」の読み方は？",
                    choices: ["しゅしょう", "しゅうしょう", "じゅしょう", "じゅうしょう"],
                    correct: 0
                },
                {
                    question: "「[[瑣末]]」の意味として正しいものは？",
                    choices: ["重要なこと", "大きなこと", "些細なこと", "新しいこと"],
                    correct: 2
                },
                {
                    question: "「[[畏敬]]」の読み方は？",
                    choices: ["いけい", "いきょう", "ひけい", "ひきょう"],
                    correct: 0
                },
                {
                    question: "「[[逸脱]]」の意味として正しいものは？",
                    choices: ["まっすぐ進むこと", "本筋から外れること", "速く走ること", "止まること"],
                    correct: 1
                },
                {
                    question: "「[[懐疑的]]」の読み方は？",
                    choices: ["かいぎてき", "かいきてき", "ふかいてき", "ふきてき"],
                    correct: 0
                },
                {
                    question: "「[[矜持]]」の意味として正しいものは？",
                    choices: ["誇りを持つこと", "恥ずかしがること", "逃げること", "攻撃すること"],
                    correct: 0
                }
            ],
            proverb: [
                {
                    question: "「石の上にも三年」の意味は？",
                    choices: ["石は3年で壊れる", "辛抱強く続ければ成功する", "石の上で3年寝る", "3年経てば忘れる"],
                    correct: 1
                },
                {
                    question: "「猿も木から落ちる」の意味は？",
                    choices: ["猿は木登りが下手", "誰でも失敗することがある", "木は危険である", "猿は弱い動物"],
                    correct: 1
                },
                {
                    question: "「早起きは三文の徳」の意味は？",
                    choices: ["早起きすると3円もらえる", "早起きは損をする", "早起きは良いことがある", "3時に起きるのが良い"],
                    correct: 2
                },
                {
                    question: "「急がば回れ」の意味は？",
                    choices: ["急ぐ時は走る", "慌てずに確実な方法を取る", "回り道は良くない", "急ぐことが大切"],
                    correct: 1
                },
                {
                    question: "「塵も積もれば山となる」の意味は？",
                    choices: ["ゴミは捨てるべき", "小さなことも積み重なれば大きくなる", "山にはゴミが多い", "掃除は大切"],
                    correct: 1
                },
                {
                    question: "「花より団子」の意味は？",
                    choices: ["花は美しい", "実利を重視する", "団子は美味しい", "花見は楽しい"],
                    correct: 1
                },
                {
                    question: "「馬の耳に念仏」の意味は？",
                    choices: ["馬は賢い", "いくら言っても効果がない", "馬はお経が好き", "動物は大切"],
                    correct: 1
                },
                {
                    question: "「笑う門には福来る」の意味は？",
                    choices: ["門で笑うと良い", "明るくしていると幸運が訪れる", "福の神は笑う", "門は大切"],
                    correct: 1
                },
                {
                    question: "「転ばぬ先の杖」の意味は？",
                    choices: ["杖は必要ない", "失敗してから準備する", "前もって用心する", "転んでも大丈夫"],
                    correct: 2
                },
                {
                    question: "「時は金なり」の意味は？",
                    choices: ["時計は高い", "時間は貴重である", "お金で時間が買える", "金は時間で作る"],
                    correct: 1
                },
                {
                    question: "「覆水盆に返らず」の意味は？",
                    choices: ["水は大切にする", "一度起きたことは取り返しがつかない", "お盆は濡れやすい", "水をこぼしてはいけない"],
                    correct: 1
                },
                {
                    question: "「虎穴に入らずんば虎子を得ず」の意味は？",
                    choices: ["虎は危険", "危険を冒さなければ成功しない", "虎の子は可愛い", "穴は危ない"],
                    correct: 1
                },
                {
                    question: "「蛙の子は蛙」の意味は？",
                    choices: ["蛙は成長しない", "子は親に似る", "蛙は子供が多い", "池には蛙がいる"],
                    correct: 1
                },
                {
                    question: "「井の中の蛙大海を知らず」の意味は？",
                    choices: ["蛙は海が嫌い", "見識が狭いこと", "井戸は深い", "海は広い"],
                    correct: 1
                },
                {
                    question: "「二階から目薬」の意味は？",
                    choices: ["目薬は高い所に置く", "効果が期待できない方法", "二階は危険", "目薬は大切"],
                    correct: 1
                },
                {
                    question: "「画竜点睛」の意味は？",
                    choices: ["絵が上手", "最後の仕上げが大切", "竜は目が大きい", "点を打つこと"],
                    correct: 1
                },
                {
                    question: "「五十歩百歩」の意味は？",
                    choices: ["50と100は違う", "大した違いはない", "歩くのは健康的", "数を数える"],
                    correct: 1
                },
                {
                    question: "「蛇足」の意味は？",
                    choices: ["蛇には足がある", "余計なもの", "蛇は速い", "足は大切"],
                    correct: 1
                },
                {
                    question: "「他山の石」の意味は？",
                    choices: ["山には石が多い", "他人の失敗も自分の教訓にする", "石は固い", "山登りは大変"],
                    correct: 1
                },
                {
                    question: "「朝三暮四」の意味は？",
                    choices: ["朝は3時、夕方は4時", "目先の違いにごまかされる", "一日は忙しい", "数字の計算"],
                    correct: 1
                }
            ]
        };
        
        // 現在の問題データ（編集可能）
        const questions = JSON.parse(JSON.stringify(originalQuestions));
        
        // グローバル変数
        let currentMode = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let answeredQuestions = [];
        let choiceCount = 4;
        let editingIndex = -1;
        
        // ローカルストレージから編集された問題を読み込む
        function loadCustomQuestions() {
            const saved = localStorage.getItem('allQuestions');
            if (saved) {
                const savedQuestions = JSON.parse(saved);
                Object.keys(savedQuestions).forEach(type => {
                    questions[type] = savedQuestions[type];
                });
            }
        }
        
        // 初期化
        loadCustomQuestions();
        
        // 配列をシャッフル
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // クイズを開始
        function startQuiz(mode) {
            currentMode = mode;
            currentQuestions = shuffleArray(questions[mode]).slice(0, 10);
            currentQuestionIndex = 0;
            correctCount = 0;
            answeredQuestions = [];
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            
            showQuestion();
        }
        
        // 問題を表示
        function showQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `問題 ${currentQuestionIndex + 1} / 10`;
            
            // 問題文を処理してアンダーバーを適用
            let questionHtml = question.question;
            questionHtml = questionHtml.replace(/\[\[(.*?)\]\]/g, '<span class="underline">$1</span>');
            document.getElementById('questionText').innerHTML = questionHtml;
            
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            
            const shuffledIndices = shuffleArray([0, 1, 2, 3].slice(0, question.choices.length));
            
            shuffledIndices.forEach((originalIndex, displayIndex) => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = `${displayIndex + 1}. ${question.choices[originalIndex]}`;
                button.onclick = () => checkAnswer(originalIndex, button);
                choicesContainer.appendChild(button);
            });
        }
        
        // 答えをチェック
        function checkAnswer(choiceIndex, buttonElement) {
            const question = currentQuestions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.choice-button');
            
            buttons.forEach(btn => {
                btn.classList.add('disabled');
                btn.onclick = null;
            });
            
            // フィードバック表示
            const feedbackOverlay = document.getElementById('feedbackOverlay');
            const feedbackCircle = document.createElement('div');
            feedbackCircle.className = 'feedback-circle';
            
            if (choiceIndex === question.correct) {
                buttonElement.classList.add('correct');
                correctCount++;
                feedbackCircle.classList.add('correct');
                feedbackCircle.textContent = '○';
            } else {
                buttonElement.classList.add('incorrect');
                buttons.forEach((btn, idx) => {
                    if (question.choices[question.correct] === btn.textContent.substring(3)) {
                        btn.classList.add('correct');
                    }
                });
                feedbackCircle.classList.add('incorrect');
                feedbackCircle.textContent = '×';
            }
            
            feedbackOverlay.appendChild(feedbackCircle);
            
            // 次へボタンを表示
            setTimeout(() => {
                document.getElementById('nextButton').classList.add('show');
            }, 800);
        }
        
        // 次の問題へ
        function nextQuestion() {
            // フィードバックをクリア
            document.getElementById('feedbackOverlay').innerHTML = '';
            document.getElementById('nextButton').classList.remove('show');
            
            currentQuestionIndex++;
            if (currentQuestionIndex < 10) {
                showQuestion();
            } else {
                showResult();
            }
        }
        
        // 結果を表示
        function showResult() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            
            const scoreElement = document.getElementById('score');
            const gradeElement = document.getElementById('grade');
            const commentElement = document.getElementById('comment');
            
            scoreElement.textContent = `${correctCount} / 10 問正解`;
            
            let grade, comment;
            if (correctCount >= 9) {
                grade = 'S';
                gradeElement.className = 'grade s';
                comment = 'すばらしい！完璧に近い成績です！\n日頃の勉強の成果が出ていますね。';
            } else if (correctCount >= 7) {
                grade = 'A';
                gradeElement.className = 'grade a';
                comment = 'よくできました！\nもう少しで完璧です。この調子で頑張りましょう！';
            } else if (correctCount >= 5) {
                grade = 'B';
                gradeElement.className = 'grade b';
                comment = 'まずまずの成績です。\n間違えた問題を復習して、次はAを目指しましょう！';
            } else {
                grade = 'C';
                gradeElement.className = 'grade c';
                comment = 'もう少し頑張りましょう。\n毎日少しずつ勉強すれば、必ず上達します！';
            }
            
            gradeElement.textContent = grade;
            commentElement.textContent = comment;
        }
        
        // クイズを再開
        function restartQuiz() {
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
        }
        
        // 問題管理画面を表示
        function showQuestionManager() {
            document.getElementById('questionManagerModal').style.display = 'flex';
            switchTab('add');
        }
        
        // 問題管理画面を非表示
        function hideQuestionManager() {
            document.getElementById('questionManagerModal').style.display = 'none';
            document.getElementById('addQuestionForm').reset();
            editingIndex = -1;
            setChoiceCount(4);
        }
        
        // タブを切り替える
        function switchTab(tab) {
            const addTab = document.getElementById('addQuestionTab');
            const manageTab = document.getElementById('manageQuestionsTab');
            const tabButtons = document.querySelectorAll('.tab-button');
            
            if (tab === 'add') {
                addTab.style.display = 'block';
                manageTab.style.display = 'none';
                tabButtons[0].classList.add('active');
                tabButtons[1].classList.remove('active');
            } else {
                addTab.style.display = 'none';
                manageTab.style.display = 'block';
                tabButtons[0].classList.remove('active');
                tabButtons[1].classList.add('active');
                loadQuestionsForManagement();
            }
        }
        
        // 選択肢の数を設定
        function setChoiceCount(count) {
            choiceCount = count;
            const buttons = document.querySelectorAll('.choice-type-button');
            const wrongAnswer3Group = document.getElementById('wrongAnswer3Group');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            if (count === 3) {
                buttons[0].classList.add('active');
                wrongAnswer3Group.style.display = 'none';
                document.getElementById('wrongAnswer3').removeAttribute('required');
            } else {
                buttons[1].classList.add('active');
                wrongAnswer3Group.style.display = 'block';
                document.getElementById('wrongAnswer3').setAttribute('required', 'required');
            }
        }
        
        // 管理用の問題をロード
        function loadQuestionsForManagement() {
            const type = document.getElementById('manageQuestionType').value;
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = '';
            
            if (questions[type] && questions[type].length > 0) {
                questions[type].forEach((question, index) => {
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    
                    // オリジナル問題かどうかを判定
                    const isOriginal = index < originalQuestions[type].length && 
                        JSON.stringify(question) === JSON.stringify(originalQuestions[type][index]);
                    
                    item.innerHTML = `
                        <div class="question-text">
                            ${question.question.replace(/\[\[(.*?)\]\]/g, '$1')}
                            ${isOriginal ? '<span style="color: #718096; font-size: 0.8em;"> (初期問題)</span>' : ''}
                        </div>
                        <div class="question-actions">
                            <button class="edit-button" onclick="editQuestion('${type}', ${index})">編集</button>
                            <button class="delete-button" onclick="deleteQuestion('${type}', ${index})">削除</button>
                        </div>
                    `;
                    questionList.appendChild(item);
                });
            } else {
                questionList.innerHTML = '<p style="text-align: center; color: #718096;">問題がありません</p>';
            }
        }
        
        // 問題を編集
        function editQuestion(type, index) {
            const question = questions[type][index];
            editingIndex = index;
            
            // タブを追加に切り替える
            switchTab('add');
            
            // フォームに値を設定
            document.getElementById('questionType').value = type;
            document.getElementById('questionTextInput').value = question.question;
            document.getElementById('correctAnswer').value = question.choices[0];
            document.getElementById('wrongAnswer1').value = question.choices[1];
            document.getElementById('wrongAnswer2').value = question.choices[2];
            
            if (question.choices.length === 3) {
                setChoiceCount(3);
                document.getElementById('wrongAnswer3').value = '';
            } else {
                setChoiceCount(4);
                document.getElementById('wrongAnswer3').value = question.choices[3];
            }
        }
        
        // 問題を削除
        function deleteQuestion(type, index) {
            if (confirm('この問題を削除してもよろしいですか？')) {
                questions[type].splice(index, 1);
                localStorage.setItem('allQuestions', JSON.stringify(questions));
                loadQuestionsForManagement();
            }
        }
        
        // フォーム送信イベント
        document.getElementById('addQuestionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('questionType').value;
            const questionText = document.getElementById('questionTextInput').value;
            const correctAnswer = document.getElementById('correctAnswer').value;
            const wrongAnswers = [
                document.getElementById('wrongAnswer1').value,
                document.getElementById('wrongAnswer2').value
            ];
            
            if (choiceCount === 4) {
                wrongAnswers.push(document.getElementById('wrongAnswer3').value);
            }
            
            const newQuestion = {
                question: questionText,
                choices: [correctAnswer, ...wrongAnswers],
                correct: 0
            };
            
            if (editingIndex !== -1) {
                // 編集モード
                questions[type][editingIndex] = newQuestion;
                alert('問題を更新しました！');
            } else {
                // 新規追加モード
                questions[type].push(newQuestion);
                alert('問題を追加しました！');
            }
            
            // すべての問題をローカルストレージに保存
            localStorage.setItem('allQuestions', JSON.stringify(questions));
            
            hideQuestionManager();
        });
        
        // モーダルの外側をクリックしたら閉じる
        document.getElementById('questionManagerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideQuestionManager();
            }
        });
    </script>
</body>
</html>